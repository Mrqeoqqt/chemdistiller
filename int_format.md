#Internal ChemDistiller hierarchical text format for spectra and annotation storage
####Overall structure
ChemDistiller uses its own tree-like formatting for the input and output spectra. 
It reflects internal representation of data. Other formats can easily be converted 
to and from this internal format. 

The overall structure is as follows:
Each file contains one MS1 spectrum. For each peak in this spectrum there can be
sub-spectra associated (MS2). For each peak in each subspectra there can be a
sub-sub-spectra associated (MS3) and so on and so forth:
```
MS1 Spectrum.txt
   ├MS1 peak
   ├MS1 peak
   │   ├MS2 spectrum
   │   │   ├MS2 peak
   │   │   ├MS2 peak
   │   │   └MS2 peak
   │   └MS2 spectrum
   │       ├MS2 peak
   │       └MS2 peak
   ├MS1 peak
   │   └MS2 spectrum
   │       ├MS2 peak
   │       ├MS2 peak
   │       │   └MS3 spectrum
   │       │       └MS3 peak
   │       └MS2 peak
   └MS1 peak
```

####Comments and spaces
__'##'__ is used to indicate a start of the comment text and anything till the end of the string after this sign is ignored by the import. Spaces and tabs at the start of the string are ignored, so identation used is only for a more readable representation. 
####Parameters
Each peak and each spectrum can have a number of parameters associated. Parameters are defined by their name and equal sign. Anything that follows the equal sign till the end of the string is treated as the parameter value. 
Parameters __'mode'__, __'collision_energy'__ and __'level'__ are automatically treated as _int_, _float_ and _int_ respectively.
Any other parameters are normally treated as strings. Example start of the MS1 spectrum file: 

```
 ##Comment line - ignoring anything starting with '##'
 exactmass=201.078978597        ##Known exact mass of the molecule is specified
 formula=C12H11NO2              ##Known formula specified
 inchi=C12H11NO2/c1-13-12(14)15-11-8-4-6-9-5-2-3-7-10(9)11/h2-8H,1H3,(H,13,14)     ##Known InChI provided
 level=1     ##Level of this spectrum. MS1 - level 1, MS2 - level 2 etc. Compulsory parameter!
 mode=-1     ##Aquisition mode, 
 ##  1 for positive aquisition mode, 
 ## -1 for negative aquisition mode. Compulsory parameter for MS1!
```

Parameters __'mode'__ and __'level'__ are compulsory and should be always provided - otherwise the engine will not know how to treat the data. Also, please do not put unnecesary spaces around __'='__ sign and do not use spaces in the names of the parameters. See the provided sample spectra in ...ChemDistiller/data/MassBankTestSpecta/. Also, parameter names are normally converted to lower case and are not case sensitive, so please use lower case for simplicity and reliability. In principle, any parameter name can be used and their values will be stored and carried over to the output. However, several parameter names are reserved for particular purposes:

 * __'level'__ - int, indicates the level of the spectrum, i.e. MS1, MS2 etc.
 * __'mode'__ - aquisition mode for spectra, 1 for positive and -1 for negative aquisition mode respectively

####Peaks
For every spectrum a list of peaks should be provided, starting with the keyword __'peaks'__ and ending with __'end'__. Each peak is defined with 3 coma-separated numbers: 

 * peak sequential number 
 * _m/z_ value in Da units
 * peak intensity

Example:

```
peaks
1,115.0554,14604.4
2,143.0502,323347.2
3,145.0295,692.0
4,168.0455,18079.5
end
```

For every peak associated parameters can be defined immediately after its definition. They are recognised by the presence of the __'='__ sign in their lines:

```
peaks
1,115.0554,14604.4
ion_type=[M-H]-
2,124.00,312.0
ion_type=[2M-H]-
```
_Note!_ __'ion_type'__ parameter should be supplied for MS1 peaks and currently only _[M+H]+_ and _[M-H]-_ adduct types will be considered by the engine (will change in the future versions).

####Sub-Spectra
Every peak can have associated sub-spectra (e.g. MS2 spectra for MS1 peaks), each beginning with the keyword __'spectrum'__ and ending with __'end'__. Each sub-spectrum can have parameters and its own peaks. Those peaks in turn can have parameters and sub-spectra defined _etc._ _etc._ Example (two MS2 spectra defined for one MS1 peak):

```
level=1
mode=-1
peaks
	1,200.07170213,100.0
		ion_type=[M-H]-
		spectrum
			collision_record=90 (nominal)
			level=2
			mode=-1
			peaks
				1,115.0554,14604.4
				2,143.0502,323347.2
				3,145.0295,692.0
				4,168.0455,18079.5
			end
		end
		spectrum
			collision_record=15 (nominal)
			level=2
			mode=-1
			peaks
				1,143.0501,228001.0
				2,182.0614,653.4
				3,200.0717,255050.8
			end
		end
end
```

####Annotations (Generated by __ChemDistiller__)
Each peak in MS1 spectrum (top level) for which MS2 subspectra are provided and which has the supported ion type (currently _[M+H]+_ and _[M-H]-_) after processing with ChemDistiller should have two additional section types associated with it: __individual__ and __merged annotations__. 

 * __Individual annotations__:
These annotations provide results aquired for each considered possible adduct type individually (although at the moment only _[M+H]+_ and _[M-H]-_ adducts are considered, the infrastructure is designed to deal with multiple possible adducts when the actual adduct is not known).

  * Each __individual annotation__ starts with __'annotation'__ keyword and ends with __'end'__ keyword. 

  * Each __individual annotation__ corresponds to one considered adduct type. There can be several __individual annotations__ for each MS1 peak corresponding to individually considered adducts. 
  * Each __individual annotation__ will have several parameters defined, including (but not limited to): __'adduct'__, __'isotope'__ and __'isotope\_extra\_mass'__. These parameters reflect the type of adduct and isotope considered by this __individual annotation__ for the MS1 peak in question. 
  * Each __individual annotation__ will have several __candidates__ defined in it and their number is limited by _--max\_results_ command line option of __ChemDistiller__. They contain the information about the candidate compounds retrieved by __ChemDistiller__ for this MS1 peak for this adduct type. They are defined in the section which starts with __'mol\_candidates'__ keyword and ends with __'end'__ keyword. __'mol\_candidates'__ section can have its own parameters defined, such as __'total\_candidate\_count'__ for the number of returned candidates and __'results\_limit'__ to indicate the maximum number of candidates allowed in this section (defined by _--max\_results_ command line option of __ChemDistiller__).

    * Inside __'mol\_candidates'__ section each __candidate__ section starts with __'candidate'__ keyword and ends with __'end'__ keyword.
    * Each candidate section will contain a number of parameters associated with the given candidate, including, but not limited to: 
        * __'adduct'__ - adduct type, 
        * __'isotope'__ - isotopic state of the compound, 
        * __'charge'__ - normal charge of the candidate molecule, 
        * __'dbname'__ - name of the chemical database containing this candidate molecule, 
        * __'formula'__ - chemical formula of the candidate compound, 
        * __'ids'__ - list of IDs by which this compound is known in the chemical database,
        * __'inchi'__ - [InChI](https://www.iupac.org/home/publications/e-resources/inchi.html) identifier of         this compound,
        * __'mz'__ - m/z value for this compound,
        * __'mass'__ - monoisotopic mass of this compound, 
        * __'smiles'__ - [SMILES](https://en.wikipedia.org/wiki/Simplified_molecular-input_line-entry_system) representation of the structure of this compound, 
        * __'scores'__ - individual calculated scores for this candidate compound. __Scores__ will be repeated for multiple individual scorers used, e.g.: "scores=Frag:0.4764998266096405" for __FragScorer__, "scores=FPT:0.485074626866" for __FingerScorer__ etc., 
        * __'totalscore'__ - combined score for this compound. By default multiplication of individual scores is used.

 * __Merged annotations__:
These annotations represent the output of merging, re-sorting and purging of the results obtained for different possible adducts, i.e. __Merged individual annotations__. Currently __Individual annotations__ and __Merged annotations__ sections will contain the same candidates due to the restricted number of considered adducts, but this will change in the future versions. 

  * Each __merged annotation__ starts with __'merged_annotation'__ keyword and ends with __'end'__ keyword. 

  * Each __merged annotation__ corresponds to one candidate compound retrieved by __ChemDistiller__. There will be multiple __merged annotations__ for each MS1 peak and their number is limited by _--max\_results_ command line option of __ChemDistiller__. 
  * Each __merged annotation__ will have several parameters defined, combining together parameters of the best scoring __individual annotations__ with the parameters of their related __candidates__. 

Example output for one MS1 spectrum in __ChemDistiller__ internal text format:

```
level=1
mode=1
peaks
	1,285.020750695,100.0,20.0
		ion_type=[M+H]+
		annotation
			adduct=[M+H]+
			isotope=0
			isotope_extra_mass=0.0
			mol_candidates
				results_limit=10
				total_candidate_count=7
				candidate
					adduct=[M+H]+
					charge=0
					dbname=MassBank
					formula=C10ClH9N4O2S
					ids=AU100601
					inchi=C10H9ClN4O2S/c11-9-5-13-6-10(14-9)15-18(16,17)8-3-1-7(12)2-4-8/h1-6H,12H2,(H,14,15)
					isotope=0
					isotopeextramass=0.0
					mz=284.013
					mass=284.013
					smiles=c1cc(ccc1N)S(=O)(=O)Nc2cncc(n2)Cl
					scores=Frag:0.4764998266096405
					scores=FPT:0.485074626866
					totalscore=0.231137975594
				end
				candidate
					adduct=[M+H]+
					charge=0
					dbname=ChEBI
					formula=C10ClH9N4O2S
					ids=59057
					inchi=C10H9ClN4O2S/c11-9-5-6-10(14-13-9)15-18(16,17)8-3-1-7(12)2-4-8/h1-6H,12H2,(H,14,15)
					isotope=0
					isotopeextramass=0.0
					mz=284.013
					mass=284.013
					smiles=C=1(C=CC(=CC1)N)S(NC=2C=CC(=NN2)Cl)(=O)=O
					scores=Frag:0.4764998266096405
					scores=FPT:0.433283358321
					totalscore=0.206459445113
				end
			end
		end
		merged_annotation
			adduct=[M+H]+
			charge=0
			dbname=MassBank
			formula=C10ClH9N4O2S
			ids=AU100601
			inchi=C10H9ClN4O2S/c11-9-5-13-6-10(14-9)15-18(16,17)8-3-1-7(12)2-4-8/h1-6H,12H2,(H,14,15)
			isotope=0
			isotopeextramass=0.0
			mz=284.013
			mass=284.013
			smiles=c1cc(ccc1N)S(=O)(=O)Nc2cncc(n2)Cl
			scores=Frag:0.4764998266096405
			scores=FPT:0.485074626866
			shortinchi=C10H9ClN4O2S/c11-9-5-13-6-10(14-9)15-18(16,17)8-3-1-7(12)2-4-8/h1-6H,12H2,(H,14,15)
			totalscore=0.231137975594
		end
		merged_annotation
			adduct=[M+H]+
			charge=0
			dbname=ChEBI
			formula=C10ClH9N4O2S
			ids=59057
			inchi=C10H9ClN4O2S/c11-9-5-6-10(14-13-9)15-18(16,17)8-3-1-7(12)2-4-8/h1-6H,12H2,(H,14,15)
			isotope=0
			isotopeextramass=0.0
			mz=284.013
			mass=284.013
			smiles=C=1(C=CC(=CC1)N)S(NC=2C=CC(=NN2)Cl)(=O)=O
			scores=Frag:0.4764998266096405
			scores=FPT:0.433283358321
			totalscore=0.206459445113
		end
		spectrum
			charge=0
			collision_record=Ramp 21.1-31.6 eV
			dbsource=MassBank
			level=2
			mode=1
			normalization=sum_one
			precursor_ion=[M+H]+
			precursor_mz=285.0208
			peaks
				0,53.0389,0.003421569760721304
				1,54.0333,0.003259738758525026
				2,55.0178,0.003005432897930875
				3,60.0552,0.0031210264709282164
				4,65.0382,0.021985897584094326
				5,66.0423,0.002912958039533002
				6,68.049,0.045798173621546645
				7,78.0333,0.004184487342503757
				8,79.0177,0.006080221939660155
				9,92.0498,0.0442954571725812
				10,93.0532,0.004207606057103225
				11,96.0443,0.0035834007629175816
				12,108.0457,0.07000346780718993
				13,109.0483,0.0067969020922436715
				14,110.0609,0.028204831811351288
				15,120.0562,0.017801410241590567
				16,130.0172,0.03252803144145185
				17,132.0138,0.008715755403999537
				18,156.0118,0.5751011443763727
				19,157.015,0.051092359264824874
				20,158.008,0.022378915732285284
				21,174.0228,0.004323199630100566
				22,184.0757,0.0035602820483181135
				23,191.9647,0.0033984510461218358
				24,219.0438,0.004161368627904289
				25,285.0221,0.02124609871691134
				26,287.0184,0.004831811351288869
			end
		end
end
```

For subsequent analysis purposes one can focus on __merged annotations__ only, while ignoring __individual annotations__ for most of the cases. However, __individual annotations__ could be of use for deeper exploration and analysis of the possible candidate compounds space.

####Note!
__JSON__ output format supported by __ChemDistiller__ fully mimics the structure of the internal text format described in this section, but combines all the individual MS1 spectra into one list. See the output generated by the test script for details.

